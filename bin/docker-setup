#!/usr/bin/env bash
# Docker setup script for Find My Club
# This script helps new developers get started with Docker quickly

set -e

echo "ğŸ³ Find My Club Docker Setup"
echo "=========================="
echo ""

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
  echo "âŒ Error: Docker is not running"
  echo "Please start Docker Desktop and try again"
  exit 1
fi

echo "âœ… Docker is running"
echo ""

# Check if .env exists
if [ ! -f .env ]; then
  echo "âŒ Error: .env file not found"
  echo ""
  echo "Please create a .env file with the following content:"
  echo ""
  echo "GOOGLE_MAPS_API_KEY=your_api_key_here"
  echo ""
  echo "Ask a team member for the actual API key values"
  exit 1
fi

echo "âœ… .env file found"
echo ""

# Check if docker-compose.yml exists
if [ ! -f docker-compose.yml ]; then
  echo "âŒ Error: docker-compose.yml not found"
  exit 1
fi

echo "âœ… docker-compose.yml found"
echo ""

# Ask if user wants to clean start
echo "Do you want to start fresh (removes existing containers and volumes)? [y/N]"
read -r response
if [[ "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
  echo "ğŸ§¹ Cleaning up existing containers and volumes..."
  docker-compose down -v
  echo "âœ… Cleanup complete"
  echo ""
fi

# Build and start services
echo "ğŸ”¨ Building Docker images (this may take a few minutes)..."
docker-compose build

echo ""
echo "ğŸš€ Starting services..."
docker-compose up -d

echo ""
echo "â³ Waiting for database to be ready..."
sleep 5

# Check if services are running
if ! docker-compose ps | grep -q "Up"; then
  echo "âŒ Error: Services failed to start"
  echo "Check logs with: docker-compose logs"
  exit 1
fi

echo "âœ… Services are running"
echo ""

# Setup database
echo "ğŸ“Š Setting up database..."
if docker-compose exec -T web bin/rails db:create; then
  echo "âœ… Database created"
else
  echo "â„¹ï¸  Database already exists (this is fine)"
fi

echo ""
echo "ğŸ”„ Running migrations..."
docker-compose exec -T web bin/rails db:migrate

echo ""
echo "ğŸŒ± Loading seed data..."
docker-compose exec -T web bin/rails db:seed

echo ""
echo "=========================================="
echo "âœ¨ Setup Complete!"
echo "=========================================="
echo ""
echo "Your Find My Club development environment is ready!"
echo ""
echo "ğŸ“ Access the application at: http://localhost:3000"
echo "ğŸ“ PostgreSQL is running on: localhost:5432"
echo ""
echo "Useful commands:"
echo "  View logs:        docker-compose logs -f web"
echo "  Rails console:    docker-compose exec web bin/rails console"
echo "  Run tests:        docker-compose exec web bundle exec rspec"
echo "  Stop services:    docker-compose down"
echo "  Restart services: docker-compose restart"
echo ""
echo "ğŸ“š For more information, see:"
echo "  - DOCKER.md (complete Docker documentation)"
echo "  - DOCKER_SETUP_SUMMARY.md (quick reference)"
echo ""
